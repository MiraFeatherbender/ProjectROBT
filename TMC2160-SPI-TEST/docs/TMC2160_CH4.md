# 4 SPI Interface

## 4.1 SPI Datagram Structure

The TMC2160 uses 40-bit SPI™ (Serial Peripheral Interface, SPI is Trademark of Motorola) datagrams for communication with a microcontroller. Microcontrollers equipped with hardware SPI typically communicate using integer multiples of 8 bits. The NCS line of the device must stay active (low) for the complete duration of the datagram transmission.

Each datagram sent to the device is composed of an address byte followed by four data bytes, allowing direct 32-bit data word communication with the register set. Each register is accessed via 32 data bits even if it uses less than 32 data bits.

- For a read access, the most significant bit of the address byte is 0.
- For a write access, the most significant bit of the address byte is 1.

Most registers are write-only, some can be read additionally, and there are also some read-only registers.

**SPI DATAGRAM STRUCTURE (MSB transmitted first):**

| 8 bit address | 32 bit data |
|---------------|-------------|
| RW + 7 bit address | 32 bit data |

- For a read access, the MSB of the address byte (bit 39) is 0.
- For a write access, the MSB of the address byte (bit 39) is 1.

**Example:**

| Action | Data sent to TMC2160 | Data received from TMC2160 |
|--------|----------------------|----------------------------|
| read TSTEP | 0x1200000000 | 0xSS & unused data |
| read TSTEP | 0x1200000000 | 0xSS & TSTEP |
| write IHOLD_IRUN:= 0x00011F10 | 0xA700ABCDEF | 0xSS & TSTEP |
| write IHOLD_IRUN:= 0x00021807 | 0xA700123456 | 0xSS00011F10 |

    *SS: placeholder for the status bits SPI_STATUS*

## 4.1.1 Selection of Write / Read (WRITE_notREAD)

The read and write selection is controlled by the MSB of the address byte (bit 39 of the SPI datagram). This bit is 0 for read access and 1 for write access. The bit named W is a WRITE_notREAD control bit. The active high write bit is the MSB of the address byte. So, 0x80 has to be added to the address for a write access.

The SPI interface always delivers data back to the master, independent of the W bit. The data transferred back is the data read from the address which was transmitted with the previous datagram, if the previous access was a read access. If the previous access was a write access, then the data read back mirrors the previously received write data.

A read access request datagram uses dummy write data. Read data is transferred back to the master with the subsequent read or write access. Hence, reading multiple registers can be done in a pipelined fashion.

Whenever data is read from or written to the TMC2160, the MSBs delivered back contain the SPI status, SPI_STATUS, a number of eight selected status bits.

## 4.1.2 SPI Status Bits Transferred with Each Datagram Read Back

New status information becomes latched at the end of each access and is available with the next SPI transfer.

**SPI_STATUS – status flags transmitted with each SPI access in bits 39 to 32:**

| Bit | Name         | Comment                                                        |
|-----|--------------|----------------------------------------------------------------|
| 7   | Unused       | Ignore this bit                                                |
| 6   | Unused       | Ignore this bit                                                |
| 5   | Unused       | Ignore this bit                                                |
| 4   | Unused       | Ignore this bit                                                |
| 3   | standstill   | DRV_STATUS[31] – 1: Signals motor stand still                  |
| 2   | sg2          | DRV_STATUS[24] – 1: Signals stallGuard flag active             |
| 1   | driver_error | GSTAT[1] – 1: Signals driver 1 driver error (clear by reading GSTAT) |
| 0   | reset_flag   | GSTAT[0] – 1: Signals that a reset has occurred (clear by reading GSTAT) |

## 4.1.3 Data Alignment

All data are right aligned. Some registers represent unsigned (positive) values, some represent integer values (signed) as two’s complement numbers, single bits or groups of bits are represented as single bits respectively as integer groups.

## 4.2 SPI Signals

The SPI bus on the TMC2160 has four signals:

- SCK – bus clock input
- SDI – serial data input
- SDO – serial data output
- CSN – chip select input (active low)

The slave is enabled for an SPI transaction by a low on the chip select input CSN. Bit transfer is synchronous to the bus clock SCK, with the slave latching the data from SDI on the rising edge of SCK and driving data to SDO following the falling edge. The most significant bit is sent first. A minimum of 40 SCK clock cycles is required for a bus transaction with the TMC2160.

If more than 40 clocks are driven, the additional bits shifted into SDI are shifted out on SDO after a 40-clock delay through an internal shift register. This can be used for daisy chaining multiple chips.

CSN must be low during the whole bus transaction. When CSN goes high, the contents of the internal shift register are latched into the internal control register and recognized as a command from the master to the slave. If more than 40 bits are sent, only the last 40 bits received before the rising edge of CSN are recognized as the command.

## 4.3 Timing

The SPI interface is synchronized to the internal system clock, which limits the SPI bus clock SCK to half of the system clock frequency. If the system clock is based on the on-chip oscillator, an additional 10% safety margin must be used to ensure reliable data transmission. All SPI inputs as well as the ENN input are internally filtered to avoid triggering on pulses shorter than 20ns.

**AC-Characteristics:**

| Parameter | Symbol | Min | Typ | Max | Unit | Conditions |
|-----------|--------|-----|-----|-----|------|------------|
| SCK valid before or after change of CSN | tCC | >2tCLK+10 | | | ns | Min time is for synchronous CLK with SCK high one tCH before CSN high only |
| CSN high time | tCSH | >tCLK+10 | | | ns | Min time is for synchronous CLK only |
| SCK low time | tCL | >tCLK+10 | | | ns | Min time is for synchronous CLK only |
| SCK high time | tCH | 10 | | | ns | assumes minimum OSC frequency |
| SCK frequency using internal clock | fSCK | | 4 | 8 | MHz | no capacitive load on SDO |
| SCK frequency using external 16MHz clock | fSCK | | 10 | 12 | MHz | rising and falling edge |
| SDI setup time before rising edge of SCK | tDU | | 12 | 20 | ns | |
| SDI hold time after rising edge of SCK | tDH | | 20 | 30 | ns | |
| Data out valid time after falling SCK clock edge | tDO | | tFILT+5 | | ns | |
| SDI, SCK and CSN filter delay time | tFILT | | | | ns | |

    *Hint: Usually this SPI timing is referred to as SPI MODE 3*
